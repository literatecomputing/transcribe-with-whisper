<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>examples/test-audio.mp3</title>
    <style>
        body {
            font-family: sans-serif;
            font-size: 18px;
            color: #111;
            padding: 0 0 1em 0;
	        background-color: #efe7dd;
        }
        table {
             border-spacing: 10px;
        }
        th { text-align: left;}
        .lt {
          color: inherit;
          text-decoration: inherit;
        }
        .l {
          color: #050;
        }
        .s {
            display: inline-block;
        }
        .c {
            display: inline-block;
        }
        .e {
            border-radius: 20px;
            width: fit-content;
            height: fit-content;
            padding: 5px 30px 5px 30px;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .t {
            display: inline-block;
        }
        #video-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: #efe7dd;
            z-index: 1000;
            padding: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #player {
            display: block;
            margin: 0 auto;
        }
        #content {
            margin-top: 380px;
        }
        .timestamp {
            color: #666;
            font-size: 14px;
            font-weight: bold;
        }
        .speaker-name {
            font-weight: bold;
            margin-right: 8px;
        }
        
        /* Edit mode styles */
        .edit-controls {
            text-align: center;
            margin: 10px 0;
        }
        .edit-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
        }
        .edit-btn:hover {
            background: #0056b3;
        }
        .edit-btn.active {
            background: #28a745;
        }
        .edit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .save-status {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .save-success {
            background: #d4edda;
            color: #155724;
        }
        .save-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Editable transcript styles */
        .transcript-segment {
            position: relative;
        }
        .transcript-segment.editable {
            border: 1px dashed #007bff;
            border-radius: 4px;
            margin: 2px 0;
        }
        .transcript-segment.editable:hover {
            background-color: #f8f9fa;
        }
        .transcript-segment.editing {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
        }
        .transcript-text {
            cursor: text;
        }
        .transcript-segment.editable .transcript-text {
            min-height: 1.2em;
            padding: 2px 4px;
            border-radius: 2px;
        }
        .transcript-text[contenteditable="true"] {
            outline: none;
            background: #fffbf0;
            border: 1px solid #ffc107;
            border-radius: 2px;
        }
        
        /* Hide server-dependent buttons when viewing as local file */
        .local-file-mode #edit-mode-btn,
        .local-file-mode #edit-speakers-btn,
        .local-file-mode #reprocess-btn,
        .local-file-mode #back-to-list-btn {
            display: none !important;
        }

        /* When editing, hide all buttons except Save Changes */
    .editing .edit-controls button { display: none !important; }
    .editing .edit-controls #save-btn { display: inline-block !important; }
    </style>
</head>
  <body>
   
    <div id="video-header" class="html-only">
    <h2 style="text-align: center; margin: 5px 0;">examples/test-audio</h2>
    <p style="text-align: center; margin: 5px 0; font-style: italic;">Click on a word to jump to that section of the video</p>
    <video id="player" style="border:none;" width="575" height="240" preload controls>
      <source src="examples/test-audio.mp3" type="video/mp4; codecs=avc1.42E01E,mp4a.40.2" />
    </video>
    
    <div class="edit-controls">
      <button id="edit-mode-btn" class="edit-btn" onclick="toggleEditMode()">üìù Edit Mode</button>
      <button id="edit-speakers-btn" class="edit-btn" onclick="editSpeakers()">üë• Edit Speakers</button>
      <button id="reprocess-btn" class="edit-btn" onclick="reprocessFile()">üîÑ Reprocess</button>
      <button id="back-to-list-btn" class="edit-btn" onclick="goBackToList()">üìã View All Files</button>
      <button id="save-btn" class="edit-btn" onclick="saveChanges()" style="display: none;">üíæ Save Changes</button>
      <button id="cancel-btn" class="edit-btn" onclick="cancelEdits()" style="display: none;">‚ùå Cancel</button>
      <span id="save-status" class="save-status"></span>
    </div>
    </div>
    <div id="content">
  <div class="e" style="background-color: white">
  
    <div class="e" style="background-color:lightgray"><span style="color:darkorange">Speaker 1</span><br>
      <div class="transcript-segment" data-start="2.055" data-end="4.975" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="0.0" data-vtt-end="2.92" data-caption-idx="0">
        <span class="timestamp">[00:00:02.06] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:02.06" class="lt" onclick="jumptoTime(2)">Okay, so today we're diving into something pretty critical</a></span>
      </div>
      <div class="transcript-segment" data-start="4.975" data-end="8.095" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="2.92" data-vtt-end="6.04" data-caption-idx="1">
        <span class="timestamp">[00:00:04.97] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:04.97" class="lt" onclick="jumptoTime(4)">in the modern tech landscape.</a></span>
      </div>
      <div class="transcript-segment" data-start="8.095" data-end="10.655" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="6.04" data-vtt-end="8.6" data-caption-idx="2">
        <span class="timestamp">[00:00:08.10] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:08.10" class="lt" onclick="jumptoTime(8)">How do you get really good AI transcription,</a></span>
      </div>
      <div class="transcript-segment" data-start="10.655" data-end="13.094999999999999" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="8.6" data-vtt-end="11.04" data-caption-idx="3">
        <span class="timestamp">[00:00:10.65] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:10.65" class="lt" onclick="jumptoTime(10)">fast, accurate, but crucially,</a></span>
      </div>
      <div class="transcript-segment" data-start="13.094999999999999" data-end="15.135" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="11.04" data-vtt-end="13.08" data-caption-idx="4">
        <span class="timestamp">[00:00:13.09] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:13.09" class="lt" onclick="jumptoTime(13)">without sending potentially sensitive stuff,</a></span>
      </div>
      <div class="transcript-segment" data-start="15.135" data-end="18.215" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="13.08" data-vtt-end="16.16" data-caption-idx="5">
        <span class="timestamp">[00:00:15.13] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:15.13" class="lt" onclick="jumptoTime(15)">audio video up to some third party cloud service?</a></span>
      </div>
      <div class="transcript-segment" data-start="18.215" data-end="20.615" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="16.16" data-vtt-end="18.56" data-caption-idx="6">
        <span class="timestamp">[00:00:18.21] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:18.21" class="lt" onclick="jumptoTime(18)">This is our deep dive into the documentation</a></span>
      </div>
      <div class="transcript-segment" data-start="20.615" data-end="23.294999999999998" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="18.56" data-vtt-end="21.24" data-caption-idx="7">
        <span class="timestamp">[00:00:20.61] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:20.61" class="lt" onclick="jumptoTime(20)">for a tool set called Transcribe with Whisper.</a></span>
      </div>
      <div class="transcript-segment" data-start="23.294999999999998" data-end="24.855" data-speaker="Speaker 1" data-vtt-file="0.vtt" data-vtt-start="21.24" data-vtt-end="22.8" data-caption-idx="8">
        <span class="timestamp">[00:00:23.29] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:23.29" class="lt" onclick="jumptoTime(23)">It's all about self-hosting.</a></span>
      </div>
    </div>
    <div class="e" style="background-color:#e1ffc7"><span style="color:darkgreen">Speaker 2</span><br>
      <div class="transcript-segment" data-start="25.039" data-end="31.119" data-speaker="Speaker 2" data-vtt-file="1.vtt" data-vtt-start="0.0" data-vtt-end="6.08" data-caption-idx="0">
        <span class="timestamp">[00:00:25.04] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:00:25.04" class="lt" onclick="jumptoTime(25)">Exactly. It's aiming to solve that chord data sovereignty problem, keeping your data completely</a></span>
      </div>
      <div class="transcript-segment" data-start="31.119" data-end="35.039" data-speaker="Speaker 2" data-vtt-file="1.vtt" data-vtt-start="6.08" data-vtt-end="10.0" data-caption-idx="1">
        <span class="timestamp">[00:00:31.12] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:00:31.12" class="lt" onclick="jumptoTime(31)">under your control. And what's really interesting here, the source material, the README,</a></span>
      </div>
    </div>
    <div class="e" style="background-color:lightgray"><span style="color:darkorange">Speaker 1</span><br>
      <div class="transcript-segment" data-start="29.764" data-end="30.264" data-speaker="Speaker 1" data-vtt-file="2.vtt" data-vtt-start="0.0" data-vtt-end="0.5" data-caption-idx="0">
        <span class="timestamp">[00:00:29.76] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:29.76" class="lt" onclick="jumptoTime(29)">Hmm.</a></span>
      </div>
    </div>
    <div class="e" style="background-color:#e1ffc7"><span style="color:darkgreen">Speaker 2</span><br>
      <div class="transcript-segment" data-start="35.552" data-end="39.952" data-speaker="Speaker 2" data-vtt-file="3.vtt" data-vtt-start="0.0" data-vtt-end="4.4" data-caption-idx="0">
        <span class="timestamp">[00:00:35.55] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:00:35.55" class="lt" onclick="jumptoTime(35)">States their goal pretty boldly. They want to make this advanced AI accessible,</a></span>
      </div>
      <div class="transcript-segment" data-start="39.952" data-end="44.512" data-speaker="Speaker 2" data-vtt-file="3.vtt" data-vtt-start="4.4" data-vtt-end="8.96" data-caption-idx="1">
        <span class="timestamp">[00:00:39.95] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:00:39.95" class="lt" onclick="jumptoTime(39)">even if your technical skill is basically just installing programs and clicking buttons.</a></span>
      </div>
      <div class="transcript-segment" data-start="44.512" data-end="52.352000000000004" data-speaker="Speaker 2" data-vtt-file="3.vtt" data-vtt-start="8.96" data-vtt-end="16.8" data-caption-idx="2">
        <span class="timestamp">[00:00:44.51] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:00:44.51" class="lt" onclick="jumptoTime(44)">That's their quote, more or less.</a></span>
      </div>
    </div>
    <div class="e" style="background-color:lightgray"><span style="color:darkorange">Speaker 1</span><br>
      <div class="transcript-segment" data-start="45.981" data-end="47.661" data-speaker="Speaker 1" data-vtt-file="4.vtt" data-vtt-start="0.0" data-vtt-end="1.68" data-caption-idx="0">
        <span class="timestamp">[00:00:45.98] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:45.98" class="lt" onclick="jumptoTime(45)">Hmm, that is ambitious.</a></span>
      </div>
      <div class="transcript-segment" data-start="47.661" data-end="48.661" data-speaker="Speaker 1" data-vtt-file="4.vtt" data-vtt-start="1.68" data-vtt-end="2.68" data-caption-idx="1">
        <span class="timestamp">[00:00:47.66] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:47.66" class="lt" onclick="jumptoTime(47)">Especially with AI tools,</a></span>
      </div>
      <div class="transcript-segment" data-start="48.661" data-end="51.061" data-speaker="Speaker 1" data-vtt-file="4.vtt" data-vtt-start="2.68" data-vtt-end="5.08" data-caption-idx="2">
        <span class="timestamp">[00:00:48.66] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:48.66" class="lt" onclick="jumptoTime(48)">they often have these really complex dependencies, right?</a></span>
      </div>
      <div class="transcript-segment" data-start="51.061" data-end="54.1" data-speaker="Speaker 1" data-vtt-file="4.vtt" data-vtt-start="5.08" data-vtt-end="8.119" data-caption-idx="3">
        <span class="timestamp">[00:00:51.06] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:51.06" class="lt" onclick="jumptoTime(51)">So does the documentation actually show they pulled it off,</a></span>
      </div>
      <div class="transcript-segment" data-start="54.1" data-end="56.101" data-speaker="Speaker 1" data-vtt-file="4.vtt" data-vtt-start="8.119" data-vtt-end="10.12" data-caption-idx="4">
        <span class="timestamp">[00:00:54.10] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:54.10" class="lt" onclick="jumptoTime(54)">hiding the complexity while, you know,</a></span>
      </div>
      <div class="transcript-segment" data-start="56.101" data-end="57.941" data-speaker="Speaker 1" data-vtt-file="4.vtt" data-vtt-start="10.12" data-vtt-end="11.96" data-caption-idx="5">
        <span class="timestamp">[00:00:56.10] </span>
        <span class="speaker-name">Speaker 1: </span>
        <span class="transcript-text"><a href="#00:00:56.10" class="lt" onclick="jumptoTime(56)">keeping that privacy promise for the data?</a></span>
      </div>
    </div>
    <div class="e" style="background-color:#e1ffc7"><span style="color:darkgreen">Speaker 2</span><br>
      <div class="transcript-segment" data-start="57.962" data-end="59.482000000000006" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="0.0" data-vtt-end="1.52" data-caption-idx="0">
        <span class="timestamp">[00:00:57.96] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:00:57.96" class="lt" onclick="jumptoTime(57)">It seems like they really have.</a></span>
      </div>
      <div class="transcript-segment" data-start="59.482000000000006" data-end="61.522000000000006" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="1.52" data-vtt-end="3.56" data-caption-idx="1">
        <span class="timestamp">[00:00:59.48] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:00:59.48" class="lt" onclick="jumptoTime(59)">The unique part is how it all fits together.</a></span>
      </div>
      <div class="transcript-segment" data-start="61.522000000000006" data-end="63.44200000000001" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="3.56" data-vtt-end="5.48" data-caption-idx="2">
        <span class="timestamp">[00:01:01.52] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:01:01.52" class="lt" onclick="jumptoTime(61)">It's not just using a powerful model</a></span>
      </div>
      <div class="transcript-segment" data-start="63.44200000000001" data-end="66.44200000000001" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="5.48" data-vtt-end="8.48" data-caption-idx="3">
        <span class="timestamp">[00:01:03.44] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:01:03.44" class="lt" onclick="jumptoTime(63)">like say, faster whisper for the accuracy.</a></span>
      </div>
      <div class="transcript-segment" data-start="66.44200000000001" data-end="70.72200000000001" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="8.48" data-vtt-end="12.76" data-caption-idx="4">
        <span class="timestamp">[00:01:06.44] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:01:06.44" class="lt" onclick="jumptoTime(66)">It intelligently bundles that with other vital things,</a></span>
      </div>
      <div class="transcript-segment" data-start="70.72200000000001" data-end="73.44200000000001" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="12.76" data-vtt-end="15.48" data-caption-idx="5">
        <span class="timestamp">[00:01:10.72] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:01:10.72" class="lt" onclick="jumptoTime(70)">like speaker separation, knowing who spoke when,</a></span>
      </div>
      <div class="transcript-segment" data-start="73.44200000000001" data-end="75.322" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="15.48" data-vtt-end="17.36" data-caption-idx="6">
        <span class="timestamp">[00:01:13.44] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:01:13.44" class="lt" onclick="jumptoTime(73)">and making sure the output plays nice</a></span>
      </div>
      <div class="transcript-segment" data-start="75.322" data-end="79.602" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="17.36" data-vtt-end="21.64" data-caption-idx="7">
        <span class="timestamp">[00:01:15.32] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:01:15.32" class="lt" onclick="jumptoTime(75)">with research software or analytical tools.</a></span>
      </div>
      <div class="transcript-segment" data-start="79.602" data-end="81.362" data-speaker="Speaker 2" data-vtt-file="5.vtt" data-vtt-start="21.64" data-vtt-end="23.4" data-caption-idx="8">
        <span class="timestamp">[00:01:19.60] </span>
        <span class="speaker-name">Speaker 2: </span>
        <span class="transcript-text"><a href="#00:01:19.60" class="lt" onclick="jumptoTime(79)">Think beyond just basic text.</a></span>
      </div>
    </div>
  </div> <!-- end of class e and speaker segments -->
    </div> <!-- end of content -->

    <script>
      console.log('Loading video highlight script...');
      
      // Detect if viewing as local file and hide server-dependent buttons
      if (window.location.protocol === 'file:') {
          console.log('Detected local file mode - hiding server-dependent buttons');
          document.body.classList.add('local-file-mode');
      }
      
      function jumptoTime(time){
          var v = document.getElementsByTagName('video')[0];
          // Jump back 0.5 seconds before the target to provide context
          var adjustedTime = Math.max(0, time - 0.5);
          console.log("jumping to time:", time, "adjusted to:", adjustedTime);
          if (v) {
              v.currentTime = adjustedTime;
          }
      }

      // Track current segment highlighting
      var currentHighlighted = null;

      function highlightCurrentSegment() {
          var v = document.getElementsByTagName('video')[0];
          if (!v) {
              console.log('Video element not found');
              return;
          }
          
          var currentTime = v.currentTime;
          // Add 3 seconds to current time to make highlighting appear ahead of audio
          var adjustedCurrentTime = currentTime + 3.0;
          console.log('Current video time:', currentTime, 'adjusted:', adjustedCurrentTime);
          
          // Find all clickable transcript segments
          var segments = document.querySelectorAll('a.lt[onclick]');
          console.log('Found segments:', segments.length);
          
          var targetSegment = null;
          
          // Find the segment that should be highlighted based on adjusted video time
          for (var i = 0; i < segments.length; i++) {
              var onclick = segments[i].getAttribute('onclick');
              if (!onclick) continue;
              
              var match = onclick.match(/jumptoTime\((\d+)\)/);
              if (!match) continue;
              
              var segmentTime = parseInt(match[1]);
              
              // Check if this is the current or most recent segment using adjusted time
              if (segmentTime <= adjustedCurrentTime) {
                  targetSegment = segments[i];
              } else {
                  break; // segments are in chronological order
              }
          }
          
          // Only update highlighting if we're switching to a different segment
          if (targetSegment !== currentHighlighted) {
              // Remove previous highlighting
              if (currentHighlighted) {
                  currentHighlighted.style.backgroundColor = '';
                  currentHighlighted.style.fontWeight = '';
                  console.log('Removed previous highlight');
              }
              
              // Highlight new segment
              if (targetSegment) {
                  targetSegment.style.backgroundColor = '#ffeb3b';
                  targetSegment.style.fontWeight = 'bold';
                  currentHighlighted = targetSegment;
                  console.log('Highlighted new segment:', targetSegment.textContent.substring(0, 50) + '...');
                  
                  // Scroll to keep current segment visible
                  targetSegment.scrollIntoView({
                      behavior: 'smooth',
                      block: 'center'
                  });
              }
          }
      }

      // Initialize when DOM is ready
      function initializeVideoTracking() {
          console.log('Initializing video tracking...');
          var v = document.getElementsByTagName('video')[0];
          if (v) {
              console.log('Video found, adding event listeners');
              // Update highlighting as video plays
              v.addEventListener('timeupdate', highlightCurrentSegment);
              
              // Also update when user seeks
              v.addEventListener('seeked', highlightCurrentSegment);
              
              // Initial highlight check
              setTimeout(highlightCurrentSegment, 100);
          } else {
              console.log('Video not found, retrying in 500ms');
              setTimeout(initializeVideoTracking, 500);
          }
      }
      
      // Edit mode functionality
      let editMode = false;
      let originalContent = {};
      
      function toggleEditMode() {
          editMode = !editMode;
          const editButton = document.querySelector('#edit-mode-btn');
          const saveButton = document.querySelector('#save-btn');
          const cancelButton = document.querySelector('#cancel-btn');
          const body = document.body;
          const segments = document.querySelectorAll('.transcript-segment');
          
          if (editMode) {
              // Enter edit mode
              body.classList.add('editing');
              editButton.textContent = 'üìù Editing...';
              // Let CSS control button visibility in edit mode
              saveButton.style.display = 'inline-block';
              // Intentionally keep cancel hidden; only Save should show while editing
              
              // Store original content and make segments editable
              segments.forEach(segment => {
                  // Store only the transcript text content, not timestamp/speaker
                  const transcriptTextSpan = segment.querySelector('.transcript-text');
                  originalContent[segment.dataset.start] = transcriptTextSpan ? transcriptTextSpan.textContent : '';
                  
                  // Make only the transcript-text span editable, not the whole segment
                  const textSpan = segment.querySelector('.transcript-text');
                  if (textSpan) {
                      textSpan.contentEditable = true;
                  }
                  segment.classList.add('editable');
              });
          } else {
              // Exit edit mode
              body.classList.remove('editing');
              editButton.textContent = 'üìù Edit Mode';
              saveButton.style.display = 'none';
              // Keep cancel hidden
              
              // Make segments non-editable
              segments.forEach(segment => {
                  const textSpan = segment.querySelector('.transcript-text');
                  if (textSpan) {
                      textSpan.contentEditable = false;
                  }
                  segment.classList.remove('editable');
              });
              
              originalContent = {};
          }
      }
      
      function saveChanges() {
          const segments = document.querySelectorAll('.transcript-segment');
          const changes = [];
          
          segments.forEach(segment => {
              const start = segment.dataset.start;
              const end = segment.dataset.end;
              const speaker = segment.dataset.speaker || '';
              const vttFile = segment.dataset.vttFile || '';
              const vttStart = segment.dataset.vttStart || '';
              const vttEnd = segment.dataset.vttEnd || '';
              const captionIdx = segment.dataset.captionIdx || '';
              
              // Extract only the text from the transcript-text span, not the timestamp and speaker
              const transcriptTextSpan = segment.querySelector('.transcript-text');
              const newText = transcriptTextSpan ? transcriptTextSpan.textContent.trim() : '';
              const originalText = originalContent[start] || '';
              
              if (newText !== originalText) {
                  changes.push({
                      // absolute timings are still included for UI uses, but server will rely on VTT-local hints
                      start: start,
                      end: end,
                      speaker: speaker,
                      text: newText,
                      originalText: originalText,
                      vttFile: vttFile,
                      vttStart: vttStart,
                      vttEnd: vttEnd,
                      captionIdx: captionIdx
                  });
              }
          });
          
          if (changes.length === 0) {
              alert('No changes detected.');
              toggleEditMode();
              return;
          }
          
          // Send changes to server
          const videoFile = window.location.pathname.split('/').pop().replace('.html', '');
          
          fetch(`/save_transcript_edits/${videoFile}`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ changes: changes })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Changes saved to VTT files! To see your changes in the HTML, click "Reprocess".');
                  toggleEditMode(); // Exit edit mode
              } else {
                  alert('Error saving changes: ' + (data.error || 'Unknown error'));
              }
          })
          .catch(error => {
              console.error('Error saving changes:', error);
              alert('Error saving changes: ' + error.message);
          });
      }
      
      function cancelEdits() {
          if (confirm('Are you sure you want to cancel all edits?')) {
              const segments = document.querySelectorAll('.transcript-segment');
              
              // Restore original content
              segments.forEach(segment => {
                  const start = segment.dataset.start;
                  if (originalContent[start]) {
                      const textSpan = segment.querySelector('.transcript-text');
                      if (textSpan) {
                          textSpan.textContent = originalContent[start];
                      }
                  }
              });
              
              toggleEditMode();
          }
      }
      
      function reprocessFile() {
          if (confirm('This will reprocess the current video file. This may take several minutes. Continue?')) {
              // Extract filename from current URL or use a data attribute
              const videoElement = document.querySelector('video source');
              if (videoElement) {
                  const videoSrc = videoElement.src;
                  const filename = videoSrc.substring(videoSrc.lastIndexOf('/') + 1);
                  
                  // Create a form and submit it like the working version on the main page
                  const form = document.createElement('form');
                  form.method = 'post';
                  form.action = '/rerun';
                  
                  const input = document.createElement('input');
                  input.type = 'hidden';
                  input.name = 'filename';
                  input.value = filename;
                  
                  form.appendChild(input);
                  document.body.appendChild(form);
                  form.submit();
              } else {
                  alert('Could not determine video filename');
              }
          }
      }
      
      function goBackToList() {
          window.location.href = '/list';
      }
      
      function editSpeakers() {
          // Extract current speakers from the page
          const speakerElements = document.querySelectorAll('.e span[style*="color:"]');
          const speakers = [];
          const seenSpeakers = new Set();
          
          speakerElements.forEach(el => {
              const speakerName = el.textContent.trim();
              if (speakerName && !seenSpeakers.has(speakerName)) {
                  seenSpeakers.add(speakerName);
                  speakers.push(speakerName);
              }
          });
          
          if (speakers.length === 0) {
              alert('No speakers found in transcript');
              return;
          }
          
          // Create a simple dialog for editing speaker names
          let dialogContent = 'Edit Speaker Names:\n\n';
          const newNames = [];
          
          for (let i = 0; i < speakers.length; i++) {
              const currentName = speakers[i];
              const newName = prompt(dialogContent + `Speaker ${i+1} (currently "${currentName}"):`);
              
              if (newName === null) {
                  // User cancelled
                  return;
              }
              
              newNames.push(newName.trim() || currentName);
              dialogContent += `Speaker ${i+1}: "${newNames[i]}"\n`;
          }
          
          // Show confirmation
          const confirmed = confirm(
              'Update speakers with these names?\n\n' + 
              speakers.map((old, i) => `"${old}" ‚Üí "${newNames[i]}"`).join('\n') +
              '\n\nThis will reprocess the file with updated speaker names.'
          );
          
          if (confirmed) {
              updateSpeakersAndReprocess(speakers, newNames);
          }
      }
      
      function updateSpeakersAndReprocess(oldNames, newNames) {
          const videoElement = document.querySelector('video source');
          if (!videoElement) {
              alert('Could not determine video filename');
              return;
          }
          
          const videoSrc = videoElement.src;
          const filename = videoSrc.substring(videoSrc.lastIndexOf('/') + 1);
          const basename = filename.replace(/\.[^/.]+$/, ""); // Remove extension
          
          // Create speaker mapping
          const speakerMapping = {};
          for (let i = 0; i < oldNames.length; i++) {
              speakerMapping[oldNames[i]] = newNames[i];
          }
          
          // Send update request
          fetch('/update-speakers', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  filename: basename,
                  speakers: speakerMapping
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Speaker names updated! Reprocessing file...');
                  // Now reprocess with updated speakers
                  reprocessFile();
              } else {
                  alert('Error updating speakers: ' + (data.message || 'Unknown error'));
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('Error updating speakers: ' + error.message);
          });
      }
      
      // Start initialization when DOM loads
      if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeVideoTracking);
      } else {
          initializeVideoTracking();
      }
    </script>
  </body>
</html>